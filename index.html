<!DOCTYPE html>
<html lang="de" class="transition-colors duration-300">
<head>
  <meta charset="UTF-8">
  <title>Entgeltbewertung</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 font-sans transition-colors duration-300">
  <div class="max-w-5xl mx-auto p-6">
    <div class="flex justify-between items-start mb-6 gap-4">
      <div class="flex-1">
        <h1 class="text-4xl font-bold mb-2">Arbeitsbewertung</h1>
        <h2 id="arbeitsplatzNameAnzeige" class="text-2xl font-semibold mb-4 text-gray-700 dark:text-gray-200"></h2>
        <label for="jobTitle" class="block text-lg mb-2">Name des Arbeitsplatzes</label>
        <input id="jobTitle" type="text" placeholder="z. B. Sachbearbeitung Einkauf"
               class="w-full text-lg rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
      </div>
      <button id="darkModeToggle" class="shrink-0 px-3 py-2 rounded-lg border border-gray-400 dark:border-gray-600 bg-white dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 mt-10" title="Hell/Dunkel umschalten">🌙</button>
    </div>

    <div id="hinweis" class="hidden mb-4 p-4 rounded-xl bg-yellow-100 text-yellow-900 text-sm shadow dark:bg-yellow-900 dark:text-yellow-100"></div>

    <div id="anforderungen" class="space-y-4"></div>

    <div id="gesamt" class="mt-10 p-6 bg-green-100 text-green-800 text-xl font-bold rounded-2xl text-center shadow-lg dark:bg-green-800 dark:text-green-100">
      Gesamtpunkte: 0
    </div>

    <div class="mt-4 flex justify-end">
      <button id="exportPdf" class="px-4 py-2 rounded-lg border border-gray-400 dark:border-gray-600 bg-green-600 text-white hover:bg-green-700">Export PDF</button>
    </div>
  </div>
  
  <script type="application/json" id="anforderungen-data">
  {
    "Physische Anforderungen": [
      {
        "name": "Körperliche Belastung",
        "beschreibung": "Lorem ipsum dolor sit amet, consectetur adipiscing elit.",
        "typ": "skala",
        "punkte": [
          {"wert": 0, "label": "Keine Belastung"},
          {"wert": 1, "label": "Leicht"},
          {"wert": 2, "label": "Mittel"},
          {"wert": 3, "label": "Schwer"}
        ]
      },
      {
        "name": "Arbeitszeitliche Belastungen",
        "beschreibung": "Unregelmäßige oder belastende Arbeitszeiten.",
        "typ": "additiv",
        "max": 3,
        "optionen": [
          {"wert": 1, "label": "Nachtarbeit"},
          {"wert": 1, "label": "Wochenendarbeit"},
          {"wert": 1, "label": "Schichtarbeit"},
          {"wert": 1, "label": "Rufbereitschaft"},
          {"wert": 1, "label": "Überstunden"}
        ]
      }
    ]
  }
  </script>
  
  <script>
    const hinweis = document.getElementById('hinweis');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const exportPdfBtn = document.getElementById('exportPdf');
    const jobTitleInput = document.getElementById('jobTitle');
    const arbeitsplatzNameAnzeige = document.getElementById('arbeitsplatzNameAnzeige');

    jobTitleInput.addEventListener('input', () => {
      arbeitsplatzNameAnzeige.textContent = jobTitleInput.value.trim();
    });

    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
      darkModeToggle.textContent = '☀️';
    }
    darkModeToggle.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      darkModeToggle.textContent = document.documentElement.classList.contains('dark') ? '☀️' : '🌙';
    });

    async function ladeAnforderungen() {
      try {
        const response = await fetch('anforderungen.json', { cache: 'no-store' });
        if (!response.ok) throw new Error('HTTP ' + response.status);
        const data = await response.json();
        render(data);
        return;
      } catch (err) {
        const embedded = document.getElementById('anforderungen-data');
        try {
          const data = JSON.parse(embedded.textContent);
          render(data);
          zeigeHinweis("Externe Datei \"anforderungen.json\" wurde nicht geladen. Eingebettete Daten werden verwendet.");
        } catch (parseErr) {
          zeigeHinweis("Fehler beim Laden der Daten. Bitte prüfen Sie die JSON-Struktur.");
          console.error('JSON-Parse-Fehler:', parseErr);
        }
      }
    }

    function zeigeHinweis(text) {
      hinweis.textContent = text;
      hinweis.classList.remove('hidden');
    }

    function styleSkalaBtn(btn, selected) {
      btn.classList.remove('bg-indigo-200','border-indigo-500','text-indigo-900','dark:bg-indigo-600','dark:text-white','dark:border-indigo-400','selected');
      if (selected) {
        btn.classList.add('bg-indigo-200','border-indigo-500','text-indigo-900','dark:bg-indigo-600','dark:text-white','dark:border-indigo-400','selected');
      }
    }
    function styleAdditivBtn(btn, active) {
      btn.classList.remove('bg-red-200','border-red-500','text-red-900','dark:bg-red-600','dark:text-white','dark:border-red-400','active');
      if (active) {
        btn.classList.add('bg-red-200','border-red-500','text-red-900','dark:bg-red-600','dark:text-white','dark:border-red-400','active');
      }
    }

    function render(data) {
      const container = document.getElementById('anforderungen');
      container.innerHTML = '';
      const farben = {
        "Wissen & Können": "bg-yellow-50 border-l-4 border-yellow-400 dark:bg-yellow-900/40 dark:border-yellow-500",
        "Psychosoziale Anforderungen": "bg-blue-50 border-l-4 border-blue-400 dark:bg-blue-900/40 dark:border-blue-500",
        "Verantwortung": "bg-green-50 border-l-4 border-green-400 dark:bg-green-900/40 dark:border-green-500",
        "Physische Anforderungen": "bg-purple-50 border-l-4 border-purple-400 dark:bg-purple-900/40 dark:border-purple-500"
      };

      Object.keys(data).forEach(gruppe => {
        const gruppeWrapper = document.createElement('div');
        gruppeWrapper.className = `gruppe-wrapper shadow-xl rounded-2xl ${farben[gruppe] || 'bg-white dark:bg-gray-800'} border dark:border-gray-700`;
        gruppeWrapper.dataset.group = gruppe;

        const header = document.createElement('div');
        header.className = 'flex items-center justify-between p-4 cursor-pointer select-none';

        const title = document.createElement('h2');
        title.className = 'text-2xl font-semibold';
        title.textContent = gruppe;

        const triangle = document.createElement('div');
        triangle.className = 'w-3 h-3 border-l-4 border-b-4 border-black dark:border-white transform transition-transform duration-200';
        triangle.style.transform = 'rotate(135deg)';

        header.appendChild(title);
        header.appendChild(triangle);
        gruppeWrapper.appendChild(header);

        const gruppeDiv = document.createElement('div');
        gruppeDiv.className = 'p-4 space-y-4';

        header.addEventListener('click', () => {
          gruppeDiv.classList.toggle('hidden');
          triangle.style.transform = gruppeDiv.classList.contains('hidden') ? 'rotate(315deg)' : 'rotate(135deg)';
        });

        data[gruppe].forEach(item => {
          const card = document.createElement('div');
          card.className = 'anforderung-card bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 border border-gray-200 dark:border-gray-700';
          card.dataset.typ = item.typ;
          card.dataset.name = item.name;
          if (item.max) card.dataset.max = item.max;

          const headerItem = document.createElement('div');
          headerItem.className = 'flex justify-between items-center mb-2';

          const label = document.createElement('div');
          label.className = 'font-bold text-lg break-words flex-1 mr-4';
          label.textContent = item.typ === 'additiv' && item.max ? `${item.name} (max. ${item.max} Punkte)` : item.name;

          const beschreibungToggle = document.createElement('button');
          beschreibungToggle.textContent = 'Mehr anzeigen';
          beschreibungToggle.className = 'text-sm text-indigo-600 dark:text-indigo-400 underline';

          headerItem.appendChild(label);
          headerItem.appendChild(beschreibungToggle);

          const beschreibung = document.createElement('p');
          beschreibung.className = 'text-sm text-gray-600 dark:text-gray-300 mt-2 hidden';
          beschreibung.textContent = item.beschreibung || '';

          beschreibungToggle.addEventListener('click', () => {
            beschreibung.classList.toggle('hidden');
            beschreibungToggle.textContent = beschreibung.classList.contains('hidden') ? 'Mehr anzeigen' : 'Weniger anzeigen';
          });

          card.appendChild(headerItem);
          card.appendChild(beschreibung);

          const wrapper = document.createElement('div');
          wrapper.className = 'space-y-2 mt-3';

          if (item.typ === 'skala') {
            (item.punkte || []).forEach(p => {
              const row = document.createElement('div');
              row.className = 'flex items-center justify-between bg-gray-50 dark:bg-gray-700 rounded-lg p-2 min-h-[3rem]';

              const lbl = document.createElement('span');
              lbl.className = 'flex-1 mr-4 break-words';
              lbl.textContent = p.label;

              const btn = document.createElement('button');
              btn.type = 'button';
              btn.textContent = `${p.wert} Punkte`;
              btn.value = Number(p.wert) || 0;
              btn.dataset.label = p.label;
              btn.className = 'skala-btn w-40 h-10 flex-shrink-0 flex items-center justify-center text-center rounded-lg border border-gray-300 bg-white dark:bg-gray-800 dark:border-gray-600 hover:bg-indigo-50 dark:hover:bg-indigo-700';

              btn.addEventListener('click', () => {
                wrapper.querySelectorAll('.skala-btn').forEach(b => styleSkalaBtn(b, false));
                styleSkalaBtn(btn, true);
                berechneSumme();
              });

              row.appendChild(lbl);
              row.appendChild(btn);
              wrapper.appendChild(row);
            });
          } else if (item.typ === 'additiv') {
            (item.optionen || []).forEach(opt => {
              const row = document.createElement('div');
              row.className = 'flex items-center justify-between bg-gray-50 dark:bg-gray-700 rounded-lg p-2 min-h-[3rem]';

              const lbl = document.createElement('span');
              lbl.className = 'flex-1 mr-4 break-words';
              lbl.textContent = opt.label;

              const cb = document.createElement('input');
              cb.type = 'checkbox';
              cb.value = Number(opt.wert) || 0;
              cb.className = 'hidden';

              const btn = document.createElement('button');
              btn.type = 'button';
              btn.textContent = `${opt.wert} Punkt`;
              btn.dataset.label = opt.label;
              btn.dataset.value = opt.wert;
              btn.className = 'additiv-btn w-40 h-10 flex-shrink-0 flex items-center justify-center text-center rounded-lg border border-gray-300 bg-white dark:bg-gray-800 dark:border-gray-600 hover:bg-red-50 dark:hover:bg-red-700';

              btn.addEventListener('click', () => {
                cb.checked = !cb.checked;
                styleAdditivBtn(btn, cb.checked);
                berechneSumme();
              });

              row.appendChild(lbl);
              row.appendChild(btn);
              row.appendChild(cb);
              wrapper.appendChild(row);
            });
          }

          card.appendChild(wrapper);
          gruppeDiv.appendChild(card);
        });

        gruppeWrapper.appendChild(gruppeDiv);
        container.appendChild(gruppeWrapper);
      });

      berechneSumme();
    }

    function berechneSumme() {
      let summe = 0;
      document.querySelectorAll('.anforderung-card').forEach(card => {
        const typ = card.dataset.typ;
        if (typ === 'skala') {
          const selected = card.querySelector('.skala-btn.selected');
          if (selected) summe += parseInt(selected.value, 10) || 0;
        } else if (typ === 'additiv') {
          const max = parseInt(card.dataset.max, 10) || Infinity;
          let subtotal = 0;
          card.querySelectorAll('.additiv-btn.active').forEach(btn => {
            subtotal += parseInt(btn.dataset.value, 10) || 0;
          });
          summe += Math.min(subtotal, max);
        }
      });
      document.getElementById('gesamt').textContent = 'Gesamtpunkte: ' + summe;
    }
    
    function setWatermark(doc) {
      doc.setFontSize(50);
      doc.setTextColor(150, 150, 150);
      doc.text('TEST BEWERTUNG', 35, 150, { angle: 45 });
      doc.setTextColor(0, 0, 0);
    }

    exportPdfBtn.addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format: 'a4' });
      let y = 12;

      setWatermark(doc);

      const title = (jobTitleInput.value && jobTitleInput.value.trim()) ? jobTitleInput.value.trim() : 'Entgeltbewertung';
      doc.setFontSize(18);
      doc.setFont(undefined, "bold");
      doc.text(title, 10, y);
      doc.setFont(undefined, "normal");
      y += 10;

      function addLine(text, inc = 6, x = 10, fontSize = 12, fontStyle = "normal", color = [0,0,0]) {
        const split = doc.splitTextToSize(text, 180);
        const prevSize = doc.getFontSize();
        doc.setFontSize(fontSize);
        doc.setFont(undefined, fontStyle);
        doc.setTextColor(...color);
        split.forEach((line, idx) => {
          if (y > 280) {
            doc.addPage();
            setWatermark(doc);
            y = 12;
            doc.setFontSize(fontSize);
            doc.setFont(undefined, fontStyle);
            doc.setTextColor(...color);
          }
          doc.text(line, x, y);
          y += (idx === split.length - 1 ? inc : 6);
        });
        doc.setFontSize(prevSize);
        doc.setFont(undefined, "normal");
        doc.setTextColor(0,0,0);
      }

      // Farbschema wie Website
      const farben = {
        "Wissen & Können": [251, 191, 36], // gelb
        "Psychosoziale Anforderungen": [59, 130, 246], // blau
        "Verantwortung": [34, 197, 94], // grün
        "Physische Anforderungen": [147, 51, 234] // violett
      };

      document.querySelectorAll('.gruppe-wrapper').forEach(group => {
        const gTitle = group.querySelector('h2')?.textContent || '';
        if (gTitle) {
          const color = farben[gTitle] || [200,200,200];
          // Farbiger Hintergrund
          doc.setFillColor(...color);
          doc.rect(8, y - 5, 194, 8, 'F');
          doc.setFontSize(14);
          doc.setFont(undefined, "bold");
          doc.setTextColor(255,255,255);
          doc.text(gTitle, 12, y);
          doc.setFont(undefined, "normal");
          doc.setTextColor(0,0,0);
          y += 10;
        }

        group.querySelectorAll('.anforderung-card').forEach(card => {
          const name = card.dataset.name || '';
          const typ = card.dataset.typ;
          addLine('• ' + name, 6, 12, 12, "bold", [0,0,0]);

          if (typ === 'skala') {
            const sel = card.querySelector('.skala-btn.selected');
            const wert = sel ? (parseInt(sel.value, 10) || 0) : '—';
            addLine(`   Punkte: ${wert}`, 6, 16, 11, "normal", [0,0,0]);
          } else if (typ === 'additiv') {
            const max = parseInt(card.dataset.max, 10) || Infinity;
            const active = card.querySelectorAll('.additiv-btn.active');
            if (active.length > 0) {
              addLine(`   (max ${max}) Auswahl:`, 6, 16, 11, "normal", [0,0,0]);
              active.forEach(btn => {
                const label = btn.dataset.label || '';
                const wert = btn.dataset.value;
                addLine(`     - ${label} (${wert} Punkt)`, 6, 20, 11, "normal", [0,0,0]);
              });
            } else {
              addLine('   Keine Auswahl', 6, 16, 11, "normal", [0,0,0]);
            }
          }
        });
      });

      // Gesamtpunktzahl am Ende
      const gesamtText = document.getElementById('gesamt')?.textContent || '';
      if (gesamtText) {
        y += 10;
        doc.setFillColor(34, 197, 94); // grün wie Website
        doc.rect(8, y - 6, 194, 10, 'F');
        doc.setFontSize(14);
        doc.setFont(undefined, "bold");
        doc.setTextColor(255,255,255);
        doc.text(gesamtText, 12, y);
        doc.setFont(undefined, "normal");
        doc.setTextColor(0,0,0);
        y += 10;
      }

      doc.save(`${title.replace(/\\s+/g,'_')}.pdf`);
    });

    ladeAnforderungen();
  </script>
</body>
</html>
